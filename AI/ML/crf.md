# CRF（条件随机场，Conditional Random Field）

- **条件随机场**首先是条件的，所以它是“判别式的”（discriminative）；和HMM相比，它用特征函数族代替条件转移概率，因为函数的连续密闭性，所以有**场(Field)**的概念；通过一个**归一化函数**$Z(x)$，给特征函数穿了一件“概率”的外衣，虽然有函数的自由场松驰，但真正实现时还是用离散的点来计算的，所以它与HMM在功效上应该没有太大差异，只是考虑更周全，思维更严谨罢了。


## 序列标注问题
我/爱/中国/共产党---$aabc$

$$
f:\Reals ^N \to R^N \newline
x_1,x_2,...x_n \to y_1,y_2,...y_n
$$

假设有:
- 词汇表 $V=\{我，爱，中国，共产党，今天，天气，不错，太好了，您好，再见\}$, 其中$|V|=10, x_i$的取值范围就是$10$,　$x_i$都是被$CNN/LSTM/Word2Vec$编码过的**隐状态**，暂且认为它是标量。
- 标注$y_i$的取值范围是$\{a,b,c\}$

为了便于理解，具体的取$n=4$
$$
Y=f(y_1,y_2,y_3,y_4;x_1,x_2,x_3,x_4) 或\newline
P(Y|X)=P(y_1,y_2,y_3,y_4|x_1,x_2,x_3,x_4) \newline
$$

可视为普通**函数**的两种表示，但又不全同于**普通函数**，在于$x_1,x_2,x_3$是有时间先后顺序的,同理$y_1,y_2,y_3$

就上述假设，这个函数是可以穷举的，其中$X有10^4$种可能，有10000个函数，因为每给定一个$X$,$Y就有3^4$种可能，取最大的可能就是函数的值；因为是一族函数交织就有了“场”的概念。

具体到例子　**"我/爱/中国/共产党---$aabc$"**  对应的是函数的单点值

- $f(y_1y_2y_3y_4;x_1=我,x_2=爱,x_3=中国,x_4=共产党)中y_1y_2y_3y_4=aabc$的值最大，$y_1y_2y_3y_4$也可以等于集合$3^4$中的其它可能。
- $P(Y|X)$表示的是一个分布（给定X），它的峰值是$P(Y=aabc|X)$

### 取序列长度$n=4$的公式推导
$$
P(y_1,...y_4|x_1,...x_4)=P(y_1,...y_4|x) \;\; x=(x_1,x_2,x_3,x_4) \tag{1} 
$$

- **假设一**　该分布是指数族分布
存在一个统一的函数$f(y_1,y_2,y_3,y_4;x)$使得

$$
P(y_1,...y_4|x)=\frac{1}{Z(x)}exp(f(y_1,y_2,y_3,y_4;x)) \tag{2}
$$

对于固定的$x, P(y_1,...y_4)$代表的是$y$取不同序列的概率，它是$(0,1)$之间且求和为$1$的。而函数$f(y_1,y_2,y_3,y_4)$是没有这个限制的，它甚至可能是负值，加一个指数就把所有映射到$(0,\infty)$了，而$Z(x)$是对$Y$的求和或积分，所以它只与$x$有关。

$$
Z(x)=\sum_{y_1y_2y_3y_4}^Y exp(f(x;y_1,y_2,y_3,y_4)) =\oint exp(f(x;y_1,y_2,y_3,y_4))dy_1dy_2dy_3dy_4 \tag{3}
$$
- **假设二** 输出之间的关联仅发生在相邻位置，并且关联是指数加性的。

这意味着$f(y_1,y_2,y_3,y_4;x)$可拆解为：
$$
f(y_1,…,y_4;x)=h(y_1;x)+g(y_1,y_2;x)+h(y_2;x)+ \newline
g(y_2,y_3;x)+h(y_3;x)+⋯+g(y_3,y_4;x)+h(y_4;x) \tag{4}
$$

注意$g$是同一个函数，它描述了所有相邻状态转移，$h$也是同一个函数，它可以用一个$RNN/CNN$做成。
假设$h$已经全面捕着了$x$和$y$的关系，就可以进一步假设$g$与$x$无关。

因此该模型可表示为:

$$
P(y_1,y_2,y_3,y_4|x)=\frac{1}{Z(x)}exp(h(y_1;x)+\sum_{k=1}^3[g(y_k,y_{k+1})+h(y_{k+1};x)]) \tag{5}
$$

这就是线性链CRF的概念

### 参考
[苏剑林. (2018, May 18). 《简明条件随机场CRF介绍(附带纯Keras实现)》](https://spaces.ac.cn/archives/5542)
